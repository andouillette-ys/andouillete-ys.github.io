{"data":{"site":{"siteMetadata":{"title":"Gandalf The Blue","author":"ys"}},"markdownRemark":{"id":"a9f560ba-07b3-56ba-9d7e-7ae453d1803f","html":"<p>最近React项目遇到一个问题，当用户在IE11上刷新页面的时候会返回404错误页面。在其他浏览器上能够正常使用。\n错误页面如下:</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/50a7cc7ecaad8e1f7506ed50ac639c5b/e7ea1/404-error.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 38.14432989690722%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABCElEQVQoz42RSW7DMAxFdf8z9AA9TrfdpF15jDU6tmTR+iFlF0WBpqmABxocP2n1ftEgIsSUK9uWkU5yJpRS/oU8ay3Uy+sb1phg3FJxYa1Yv2C+xZq87zvoARKTwTFGNE0LVXbCHAKMMYzGsiyscsOWUrUrJ0YemHN+iOTJlm3XQRHt1TGOV57QoG07DMOIruvZN/L3gJ4RFVL0GxKTJzVKbua9ZwICI80lQfzbecfD/qUw8+rlaCjHl3tdJ80rW0xsjxW/mz4jpUOE1HJDgg0RWjsY66HNYS0TI9+S4+kJkkNUMM83KMeqrOYfIgpP9DRBX6fql7gzX/YnEvfW8e17fFw+MfYD7tUabJ1Ns7rVAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"IE 404 错误页面\"\n        title=\"\"\n        src=\"/static/50a7cc7ecaad8e1f7506ed50ac639c5b/fb8a0/404-error.png\"\n        srcset=\"/static/50a7cc7ecaad8e1f7506ed50ac639c5b/1a291/404-error.png 148w,\n/static/50a7cc7ecaad8e1f7506ed50ac639c5b/2bc4a/404-error.png 295w,\n/static/50a7cc7ecaad8e1f7506ed50ac639c5b/fb8a0/404-error.png 590w,\n/static/50a7cc7ecaad8e1f7506ed50ac639c5b/e7ea1/404-error.png 776w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>项目背景：<br/>\n1， 利用 create react app 构建<br/>\n2， 部署在tomcat上<br/>\n3， 采用 H5 History 路由<br/></p>\n<p>由于是客户端路由，我们在tomcat里面配置如下:\n<error-page>\n<error-code>404</error-code>\n<location>/index.html</location>\n</error-page></p>\n<p>根据以上的配置，我发现项目在除了IE的情况下，F5刷新都可以重新加载项目，而在IE下刷新就会出现上面的错误页面。\n经过一番研究，造成这个问题的原因是IE 的 Friendly HTTP Error Pages</p>\n<p>我们的tomcat每次返回404然后返回index.html的时候，我们的Index.html是小于512 bytes，IE 就会替换Index.html为它自己的错误页面，也即最开始出现的错误页面。</p>\n<p>知道了造成问题的原因后，解决问题就很简单，在Index.html里面添加字符使其大于512 bytes。</p>\n<p>I heard <a href=\"https://reactjs.org/docs/hooks-intro.html\">Hooks</a> are the new hotness. Ironically, I want to start this blog by describing fun facts about <em>class</em> components. How about that!</p>\n<p><strong>These gotchas are <em>not</em> important for using React productively. But you might find them amusing if you like to dig deeper into how things work.</strong></p>\n<p>Here’s the first one.</p>\n<hr>\n<p>I wrote <code class=\"language-text\">super(props)</code> more times in my life than I’d like to know:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Checkbox</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> isOn<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Of course, the <a href=\"https://github.com/tc39/proposal-class-fields\">class fields proposal</a> lets us skip the ceremony:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Checkbox</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> isOn<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>A syntax like this was <a href=\"https://reactjs.org/blog/2015/01/27/react-v0.13.0-beta-1.html#es7-property-initializers\">planned</a> when React 0.13 added support for plain classes in 2015. Defining <code class=\"language-text\">constructor</code> and calling <code class=\"language-text\">super(props)</code> was always intended to be a temporary solution until class fields provide an ergonomic alternative.</p>\n<p>But let’s get back to this example using only ES2015 features:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Checkbox</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> isOn<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>Why do we call <code class=\"language-text\">super</code>? Can we <em>not</em> call it? If we have to call it, what happens if we don’t pass <code class=\"language-text\">props</code>? Are there any other arguments?</strong> Let’s find out.</p>\n<hr>\n<p>In JavaScript, <code class=\"language-text\">super</code> refers to the parent class constructor. (In our example, it points to the <code class=\"language-text\">React.Component</code> implementation.)</p>\n<p>Importantly, you can’t use <code class=\"language-text\">this</code> in a constructor until <em>after</em> you’ve called the parent constructor. JavaScript won’t let you:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Checkbox</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 🔴 Can’t use `this` yet</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// ✅ Now it’s okay though</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> isOn<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>There’s a good reason for why JavaScript enforces that parent constructor runs before you touch <code class=\"language-text\">this</code>. Consider a class hierarchy:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Person</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">PolitePerson</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Person</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">greetColleagues</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 🔴 This is disallowed, read below why</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">greetColleagues</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Good morning folks!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Imagine using <code class=\"language-text\">this</code> before <code class=\"language-text\">super</code> call <em>was</em> allowed. A month later, we might change <code class=\"language-text\">greetColleagues</code> to include the person’s name in the message:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">  <span class=\"token function\">greetColleagues</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Good morning folks!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'My name is '</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">+</span> <span class=\"token string\">', nice to meet you!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>But we forgot that <code class=\"language-text\">this.greetColleagues()</code> is called before the <code class=\"language-text\">super()</code> call had a chance to set up <code class=\"language-text\">this.name</code>. So <code class=\"language-text\">this.name</code> isn’t even defined yet! As you can see, code like this can be very difficult to think about.</p>\n<p>To avoid such pitfalls, <strong>JavaScript enforces that if you want to use <code class=\"language-text\">this</code> in a constructor, you <em>have to</em> call <code class=\"language-text\">super</code> first.</strong> Let the parent do its thing! And this limitation applies to React components defined as classes too:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// ✅ Okay to use `this` now</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> isOn<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>This leaves us with another question: why pass <code class=\"language-text\">props</code>?</p>\n<hr>\n<p>You might think that passing <code class=\"language-text\">props</code> down to <code class=\"language-text\">super</code> is necessary so that the base <code class=\"language-text\">React.Component</code> constructor can initialize <code class=\"language-text\">this.props</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// Inside React</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props <span class=\"token operator\">=</span> props<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And that’s not far from truth — indeed, that’s <a href=\"https://github.com/facebook/react/blob/1d25aa5787d4e19704c049c3cfa985d3b5190e0d/packages/react/src/ReactBaseClasses.js#L22\">what it does</a>.</p>\n<p>But somehow, even if you call <code class=\"language-text\">super()</code> without the <code class=\"language-text\">props</code> argument, you’ll still be able to access <code class=\"language-text\">this.props</code> in the <code class=\"language-text\">render</code> and other methods. (If you don’t believe me, try it yourself!)</p>\n<p>How does <em>that</em> work? It turns out that <strong>React also assigns <code class=\"language-text\">props</code> on the instance right after calling <em>your</em> constructor:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">  <span class=\"token comment\">// Inside React</span>\n  <span class=\"token keyword\">const</span> instance <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">YourComponent</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  instance<span class=\"token punctuation\">.</span>props <span class=\"token operator\">=</span> props<span class=\"token punctuation\">;</span></code></pre></div>\n<p>So even if you forget to pass <code class=\"language-text\">props</code> to <code class=\"language-text\">super()</code>, React would still set them right afterwards. There is a reason for that.</p>\n<p>When React added support for classes, it didn’t just add support for ES6 classes alone. The goal was to support as wide range of class abstractions as possible. It was <a href=\"https://reactjs.org/blog/2015/01/27/react-v0.13.0-beta-1.html#other-languages\">not clear</a> how relatively successful would ClojureScript, CoffeeScript, ES6, Fable, Scala.js, TypeScript, or other solutions be for defining components. So React was intentionally unopinionated about whether calling <code class=\"language-text\">super()</code> is required — even though ES6 classes are.</p>\n<p>So does this mean you can just write <code class=\"language-text\">super()</code> instead of <code class=\"language-text\">super(props)</code>?</p>\n<p><strong>Probably not because it’s still confusing.</strong> Sure, React would later assign <code class=\"language-text\">this.props</code> <em>after</em> your constructor has run. But <code class=\"language-text\">this.props</code> would still be undefined <em>between</em> the <code class=\"language-text\">super</code> call and the end of your constructor:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// Inside React</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props <span class=\"token operator\">=</span> props<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Inside your code</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Button</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 😬 We forgot to pass props</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// ✅ {}</span>\n<span class=\"gatsby-highlight-code-line\">    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 😬 undefined </span></span>  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>It can be even more challenging to debug if this happens in some method that’s called <em>from</em> the constructor. <strong>And that’s why I recommend always passing down <code class=\"language-text\">super(props)</code>, even though it isn’t strictly necessary:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Button</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ✅ We passed props</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">// ✅ {}</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ✅ {}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This ensures <code class=\"language-text\">this.props</code> is set even before the constructor exits.</p>\n<hr>\n<p>There’s one last bit that longtime React users might be curious about.</p>\n<p>You might have noticed that when you use the Context API in classes (either with the legacy <code class=\"language-text\">contextTypes</code> or the modern <code class=\"language-text\">contextType</code> API added in React 16.6), <code class=\"language-text\">context</code> is passed as a second argument to the constructor.</p>\n<p>So why don’t we write <code class=\"language-text\">super(props, context)</code> instead? We could, but context is used less often so this pitfall just doesn’t come up as much.</p>\n<p><strong>With the class fields proposal this whole pitfall mostly disappears anyway.</strong> Without an explicit constructor, all arguments are passed down automatically. This is what allows an expression like <code class=\"language-text\">state = {}</code> to include references to <code class=\"language-text\">this.props</code> or <code class=\"language-text\">this.context</code> if necessary.</p>\n<p>With Hooks, we don’t even have <code class=\"language-text\">super</code> or <code class=\"language-text\">this</code>. But that’s a topic for another day.</p>","timeToRead":5,"frontmatter":{"title":"React 项目在IE11下刷新页面出现404错误","date":"March 09, 2019","spoiler":null},"fields":{"slug":"/refresh-react-project-in-IE11-404-error/","langKey":"en"}}},"pageContext":{"slug":"/refresh-react-project-in-IE11-404-error/","previous":{"fields":{"slug":"/why-do-we-write-super-props/","langKey":"en","directoryName":"why-do-we-write-super-props"},"frontmatter":{"title":"Why Do We Write super(props)?"}},"next":null,"translations":[]}}